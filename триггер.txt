CREATE OR REPLACE TRIGGER smtp_insert --триггер, который вызывается после INSERT в таблицу new_tables
AFTER INSERT ON new_tables
FOR EACH ROW
DECLARE
     c utl_smtp.connection; -- переменная, представляющая smtp-соединение
     lvu_name lvus.lvu_name%TYPE; --переменная для хранения значения из таблицы lvus
     log_date logs.log_date%TYPE; --переменная для хранения значения из таблицы logs
     type_name types.type_name%TYPE; --переменная для хранения значения из таблицы types
     task tasks.task%TYPE; --переменная для хранения значения из таблицы tasks
     prog_name programs.program_name%TYPE; --переменная для хранения значения из таблицы programs
     smtpHost VARCHAR(65) := 'smtp.gmail.com';
	 smtpPort INTEGER:= 587;
	 emailHost VARCHAR(65) := 'andreytokarchuk0989@gmail.com';
	 emailPassword VARCHAR(65) := '08522580..';
BEGIN   
    c := utl_smtp.open_connection(
            host => smtpHost
            ,port => smtpPort
            , wallet_path => 'file:C:\app\google_sert' --ваш путь
            , wallet_password => 'banzai4ever' --ваш пароль от пакета
            , secure_connection_before_smtp => false
       ); --когда так открывается коннектор, то ehlo. Это для обоих способов авторизации
    utl_smtp.ehlo(c, smtpHost);
    utl_smtp.starttls(c); 
    utl_smtp.ehlo(c, smtpHost);
    utl_smtp.auth(
      c => c,
      username => emailHost,
      password => emailPassword,
      schemes  => utl_smtp.all_schemes
					);
--    For i in (SELECT * FROM mails) loop        
--    
--                utl_smtp.mail(c, emailHost);
--		utl_smtp.rcpt(c, i.mail);
--		utl_smtp.open_data(c); 
--		utl_smtp.write_data(c, 'From: andreytokarchuk0989@gmail.com' || utl_tcp.crlf); --ваша почта
--		utl_smtp.write_data(c, 'To:'|| i.mail || utl_tcp.crlf);
--		utl_smtp.write_data(c, 'Subject: pismo'|| utl_tcp.crlf);
--		utl_smtp.write_data(c, 'Content-Type: text/plain' || utl_tcp.crlf);
--		utl_smtp.write_data(c, 'X-Mailer: SMTP' || utl_tcp.crlf);
--		utl_smtp.write_data(c, utl_tcp.crlf);
--
--		--курсоры для получения значений из таблиц по значениям внешних ключей, добавленных в таблицу new_tables
--		SELECT lvu_name INTO lvu_name FROM lvus WHERE lvus.lvu_id = :new.log_id; --курсор для получения значения lvu_name из таблицы lvus
--		SELECT log_date INTO log_date FROM logs WHERE logs.log_id = :new.log_id; --курсор для получения значения log_date из таблицы logs
--		SELECT type_name INTO type_name FROM types WHERE types.type_id = :new.type_id; --курсор для получения значения type_name из таблицы types
--		SELECT task INTO task FROM tasks WHERE tasks.task_id = :new.task_id; --курсор для получения значения task из таблицы tasks
--		SELECT program_name INTO prog_name FROM programs WHERE programs.program_id = :new.program_id; --курсор для получения значения program_name из таблицы programs
--		
--		utl_smtp.write_data(c, 'LVU=' || lvu_name || utl_tcp.CRLF ||
--											   'LOG_DATE=' || TO_CHAR(log_date) || utl_tcp.CRLF ||
--											   'TYPE_NAME=' || type_name || utl_tcp.CRLF ||
--											   'TASK=' || task || utl_tcp.CRLF ||
--											   'PROGRAM_NAME=' || prog_name || utl_tcp.CRLF); --тело сообщения с нужными данными
--		
--		utl_smtp.close_data(c); --завершение сессии 
--		
    END LOOP;
	
    utl_smtp.quit(c); --закрытие соединения 
EXCEPTION
    WHEN utl_smtp.transient_error OR utl_smtp.permanent_error THEN --transient_error - при получении кода 4хх(ошибка на стороне клиента); permanent_error - при получении кода 5хх(ошибка на стороне сервера)
        BEGIN
            utl_smtp.quit(c); -- при этих ошибках закрываем соединение
        EXCEPTION
            WHEN utl_smtp.transient_error OR utl_smtp.permanent_error THEN
                NULL; -- When the SMTP server is down or unavailable, we don't
                   -- have a connection to the server. The quit call will
                   -- raise an exception that we can ignore.
        END;
        raise_application_error(-20000,
           'Failed to send mail due to the following error: ' || sqlerrm); --вызываем исключение с сообщением(sqlerrm) об ошибки
END;




begin
SEND_MAIL_TEST.mail_test('andreytokarchuk0989@gmail.com', 'ofjgodjfogkdg', 'gihfigjdhgfifg');
end;